<!DOCTYPE html>
<html>
    <head>
        <%- include('./partials/head'); %> 
    </head>
    <body>
        <div class="wrapper">
            <%- include('./partials/header'); %> 
            
            <div class="container">
                <div class="page-inner">
                  <div class="page-header">
                    <h3 class="fw-bold mb-3">Upload Data e-RDKK</h3>
                    <ul class="breadcrumbs mb-3">
                      <li class="nav-home">
                        <a href="/">
                          <i class="icon-home"></i>
                        </a>
                      </li>
                      <li class="separator">
                        <i class="icon-arrow-right"></i>
                      </li>
                      <li class="nav-item">
                        <a href="/upload-erdkk">Upload</a>
                      </li>
                      <li class="separator">
                        <i class="icon-arrow-right"></i>
                      </li>
                      <li class="nav-item">
                        <a href="/upload-erdkk">Upload Data e-RDKK</a>
                      </li>
                    </ul>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="card">
                        <div class="card-header">
                          <div class="card-title">Upload Data e-RDKK</div>
                        </div>
                        <div class="card">
                          <div class="card-body">
                              <form id="uploadForm" enctype="multipart/form-data">
                                  <div class="row">
                                      <!-- Tahun Input -->
                                      <div class="col-md-6">
                                          <div class="form-group">
                                              <label for="tahun">Tahun</label>
                                              <input type="number" class="form-control" id="tahun" name="tahun" required placeholder="Masukkan Tahun" min="2000" max="2100">
                                          </div>
                                      </div>
                      
                                      <!-- Dropdown Kabupaten -->
                                      <div class="col-md-6">
                                          <div class="form-group">
                                              <label for="kabupaten">Kabupaten</label>
                                              <select class="form-control" id="kabupaten" name="kabupaten" required>
                                                  <option value="">Pilih Kabupaten</option>
                                                  <option value="BOYOLALI">BOYOLALI</option>
              <option value="SRAGEN">SRAGEN</option>
              <option value="KOTA SURAKARTA">KOTA SURAKARTA</option>
              <option value="KOTA MAGELANG">KOTA MAGELANG</option>
              <option value="MAGELANG">MAGELANG</option>
              <option value="SUKOHARJO">SUKOHARJO</option>
              <option value="KLATEN">KLATEN</option>
              <option value="WONOGIRI">WONOGIRI</option>
              <option value="KARANGANYAR">KARANGANYAR</option>
              <option value="BLORA">BLORA</option>
              <option value="GROBOGAN">GROBOGAN</option>
              <option value="JEPARA">JEPARA</option>
              <option value="KUDUS">KUDUS</option>
              <option value="PATI">PATI</option>
              <option value="REMBANG">REMBANG</option>
              <option value="BANTUL">BANTUL</option>
              <option value="KOTA YOGYAKARTA">KOTA YOGYAKARTA</option>
              <option value="SLEMAN">SLEMAN</option>
              <option value="KULON PROGO">KULON PROGO</option>
              <option value="GUNUNG KIDUL">GUNUNG KIDUL</option>

                                              </select>
                                          </div>
                                      </div>
                      
                                      <!-- File Upload -->
                                      <div class="col-md-6">
                                          <div class="form-group">
                                              <label for="fileInput">Upload File (.xlsx)</label>
                                              <input type="file" class="form-control-file" id="fileInput" name="file" accept=".xlsx, .csv" required>
                                          </div>
                                      </div>
                                  </div>
                      
                                  <!-- Submit Button -->
                                  <div class="d-flex mt-3">
                                    <button type="submit" class="btn btn-success me-3">Upload</button>
                                    <button id="openModal" class="btn btn-outline-primary">Petunjuk</button>
                                  </div>
                                <div
                                  id="modalPetunjuk"
                                  class="modal fade"
                                  tabindex="-1"
                                  aria-hidden="true"
                                >
                                  <div class="modal-dialog">
                                    <div class="modal-content">
                                      <div class="modal-header">
                                        <h5 class="modal-title">Petunjuk</h5>
                                        <button
                                          type="button"
                                          class="btn-close"
                                          data-bs-dismiss="modal"
                                          aria-label="Close"
                                        ></button>
                                      </div>
                                      <div class="modal-body">
                                        <!-- Menu Navigasi dalam Modal -->
                                        <ul class="nav nav-tabs mb-3">
                                          <li class="nav-item">
                                            <a
                                              class="nav-link active"
                                              id="btnHelp"
                                              href="#"
                                              >Help</a
                                            >
                                          </li>
                                          <li class="nav-item">
                                            <a class="nav-link" id="btnKartan" href="#"
                                              >Template e-ERDKK JATENG</a
                                            >
                                          </li>
                                          <li class="nav-item">
                                            <a class="nav-link" id="btnKartanDiy" href="#"
                                              >Template e-ERDKK Khusus DIY</a
                                            >
                                          </li>
                                        </ul>

                                        <!-- Konten Modal -->
                                        <div
                                          id="contentHelp"
                                          class="modal-content-section"
                                        >
                                          <p>
                                            <ol>
                                              <li>
                                                Pastikan file yang diupload dalam format excel (.xlsx)
                                              </li>
                                              <li>
                                                Secara default system sudah bisa menangani upload file erdkk format m1-m3.
                                              </li>
                                              <li>
                                                Pastikan kembali file excel sesuai format dan template, untuk lihat template e-RDKK.
                                              </li>
                                            </ol>
                                          </p>
                                        </div>
                                        <div
                                          id="contentKartan"
                                          class="modal-content-section d-none"
                                        >
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                          <table class="table table-striped table-bordered">
                                            <thead class="thead-dark">
                                              <tr>
                                                <th>Nama Penyuluh</th>
                                                <th>Kode Kecamatan</th>
                                                <th>Kecamatan</th>
                                                <th>Kode Desa</th>
                                                <th>Kode Kios Pengecer</th>
                                                <th>Nama Kios Pengecer</th>
                                                <th>Gapoktan</th>
                                                <th>Nama Poktan</th>
                                                <th>Nama Petani</th>
                                                <th>KTP</th>
                                                <th>Tempat Lahir</th>
                                                <th>Tanggal Lahir</th>
                                                <th>Nama Ibu Kandung</th>
                                                <th>Alamat</th>
                                                <th>Subsektor</th>
                                                <th>Komoditas MT1</th>
                                                <th>Luas Lahan (Ha) MT1</th>
                                                <th>Pupuk Urea (Kg) MT1</th>
                                                <th>Pupuk NPK (Kg) MT1</th>
                                                <th>Pupuk NPK Formula (Kg) MT1</th>
                                                <th>Pupuk Organik (Kg) MT1</th>
                                                <th>Komoditas MT2</th>
                                                <th>Luas Lahan (Ha) MT2</th>
                                                <th>Pupuk Urea (Kg) MT2</th>
                                                <th>Pupuk NPK (Kg) MT2</th>
                                                <th>Pupuk NPK Formula (Kg) MT2</th>
                                                <th>Pupuk Organik (Kg) MT2</th>
                                                <th>Komoditas MT3</th>
                                                <th>Luas Lahan (Ha) MT3</th>
                                                <th>Pupuk Urea (Kg) MT3</th>
                                                <th>Pupuk NPK (Kg) MT3</th>
                                                <th>Pupuk NPK Formula (Kg) MT3</th>
                                                <th>Pupuk Organik (Kg) MT3</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              <tr>
                                                <td>John Doe</td>
                                                <td>1101</td>
                                                <td>Kecamatan A</td>
                                                <td>2201</td>
                                                <td>K001</td>
                                                <td>Kios Sejahtera</td>
                                                <td>Gapoktan A</td>
                                                <td>Poktan B</td>
                                                <td>Petani C</td>
                                                <td>1234567890123456</td>
                                                <td>Jakarta</td>
                                                <td>01-01-1980</td>
                                                <td>Ibu C</td>
                                                <td>Jl. Contoh No. 123</td>
                                                <td>Padi</td>
                                                <td>Padi</td>
                                                <td>2</td>
                                                <td>50</td>
                                                <td>20</td>
                                                <td>10</td>
                                                <td>5</td>
                                                <td>Jagung</td>
                                                <td>3</td>
                                                <td>60</td>
                                                <td>25</td>
                                                <td>12</td>
                                                <td>6</td>
                                                <td>Kedelai</td>
                                                <td>1.5</td>
                                                <td>40</td>
                                                <td>15</td>
                                                <td>8</td>
                                                <td>4</td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </div>
                                        </div>

                                        <div
                                          id="contentKartanDiy"
                                          class="modal-content-section d-none"
                                        >
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                          <table class="table table-striped table-bordered">
                                            <thead class="thead-dark">
                                              <tr>
                                                <th>Nama Penyuluh</th>
                                                <th>Kode Kecamatan</th>
                                                <th>Kecamatan</th>
                                                <th>Kode Desa</th>
                                                <th>Kode Kios Pengecer</th>
                                                <th>Nama Kios Pengecer</th>
                                                <th>Gapoktan</th>
                                                <th>Nama Poktan</th>
                                                <th>Nama Petani</th>
                                                <th>KTP</th>
                                                <th>Tempat Lahir</th>
                                                <th>Alamat</th>
                                                <th>Subsektor</th>
                                                <th>Komoditas MT1</th>
                                                <th>Luas Lahan (Ha) MT1</th>
                                                <th>Pupuk Urea (Kg) MT1</th>
                                                <th>Pupuk NPK (Kg) MT1</th>
                                                <th>Pupuk NPK Formula (Kg) MT1</th>
                                                <th>Pupuk Organik (Kg) MT1</th>
                                                <th>Komoditas MT2</th>
                                                <th>Luas Lahan (Ha) MT2</th>
                                                <th>Pupuk Urea (Kg) MT2</th>
                                                <th>Pupuk NPK (Kg) MT2</th>
                                                <th>Pupuk NPK Formula (Kg) MT2</th>
                                                <th>Pupuk Organik (Kg) MT2</th>
                                                <th>Komoditas MT3</th>
                                                <th>Luas Lahan (Ha) MT3</th>
                                                <th>Pupuk Urea (Kg) MT3</th>
                                                <th>Pupuk NPK (Kg) MT3</th>
                                                <th>Pupuk NPK Formula (Kg) MT3</th>
                                                <th>Pupuk Organik (Kg) MT3</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              <tr>
                                                <td>John Doe</td>
                                                <td>1101</td>
                                                <td>Kecamatan A</td>
                                                <td>2201</td>
                                                <td>K001</td>
                                                <td>Kios Sejahtera</td>
                                                <td>Gapoktan A</td>
                                                <td>Poktan B</td>
                                                <td>Petani C</td>
                                                <td>1234567890123456</td>
                                                <td>Jakarta</td>
                                                <td>Jl. Contoh No. 123</td>
                                                <td>Padi</td>
                                                <td>Padi</td>
                                                <td>2</td>
                                                <td>50</td>
                                                <td>20</td>
                                                <td>10</td>
                                                <td>5</td>
                                                <td>Jagung</td>
                                                <td>3</td>
                                                <td>60</td>
                                                <td>25</td>
                                                <td>12</td>
                                                <td>6</td>
                                                <td>Kedelai</td>
                                                <td>1.5</td>
                                                <td>40</td>
                                                <td>15</td>
                                                <td>8</td>
                                                <td>4</td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </div>
                                        </div>
                                        
                                      </div>
                                      <div class="modal-footer">
                                        <button
                                          type="button"
                                          class="btn btn-danger"
                                          data-bs-dismiss="modal"
                                        >
                                          Tutup
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </form>
                          </div>
                      </div>                      
                    </div>
                  </div>
                </div>
              </div>
              <%- include('./partials/footer'); %> 

        <!-- End Custom template -->
    </div>
    <!--   Core JS Files   -->
    <!--   Core JS Files   -->
    <script src="../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>

    <!-- jQuery Scrollbar -->
    <script src="../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>

    <!-- Chart JS -->
    <script src="../assets/js/plugin/chart.js/chart.min.js"></script>

    <!-- jQuery Sparkline -->
    <script src="../assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>

    <!-- Chart Circle -->
    <script src="../assets/js/plugin/chart-circle/circles.min.js"></script>

    <!-- Datatables -->
    <script src="../assets/js/plugin/datatables/datatables.min.js"></script>

    <!-- Bootstrap Notify -->
    <script src="../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

    <!-- jQuery Vector Maps -->
    <script src="../assets/js/plugin/jsvectormap/jsvectormap.min.js"></script>
    <script src="../assets/js/plugin/jsvectormap/world.js"></script>

    <!-- Google Maps Plugin -->
    <script src="../assets/js/plugin/gmaps/gmaps.js"></script>

    <!-- Sweet Alert -->
    <script src="../assets/js/plugin/sweetalert/sweetalert.min.js"></script>

    <!-- Kaiadmin JS -->
    <script src="../assets/js/kaiadmin.min.js"></script>

    <!-- Kaiadmin DEMO methods, don't include it in your project! -->
    <script src="../assets/js/setting-demo2.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
          // Modal Petunjuk
          let openModal = document.getElementById("openModal");
          let modalElement = document.getElementById("modalPetunjuk");
      
          if (openModal && modalElement) {
              openModal.addEventListener("click", function () {
                  let modal = new bootstrap.Modal(modalElement);
                  modal.show();
                  showContent("contentHelp"); // Default ke Help
              });
          }
      
          let btnHelp = document.getElementById("btnHelp");
          let btnKartan = document.getElementById("btnKartan");
          let btnKartanDiy = document.getElementById("btnKartanDiy");
      
          if (btnHelp) {
              btnHelp.addEventListener("click", function () {
                  showContent("contentHelp");
              });
          }
      
          if (btnKartan) {
              btnKartan.addEventListener("click", function () {
                  showContent("contentKartan");
              });
          }

          if (btnKartanDiy) {
              btnKartanDiy.addEventListener("click", function () {
                  showContent("contentKartanDiy");
              });
          }
      
          function showContent(contentId) {
              document.querySelectorAll(".modal-content-section").forEach((el) => el.classList.add("d-none"));
              let content = document.getElementById(contentId);
              if (content) content.classList.remove("d-none");
          }
      
          // Fetch Kabupaten
          let kabupatenDropdown = document.getElementById("kabupaten");
          // if (kabupatenDropdown) {
          //     fetch("/api/filters")
          //         .then(response => response.json())
          //         .then(data => {
          //             if (data && data.kabupaten && Array.isArray(data.kabupaten)) {
          //                 let existingValues = new Set();
          //                 kabupatenDropdown.innerHTML = '<option value="">Pilih Kabupaten</option>';
      
          //                 data.kabupaten.forEach(kab => {
          //                     if (kab && !existingValues.has(kab)) {
          //                         existingValues.add(kab);
          //                         let option = document.createElement("option");
          //                         option.value = kab;
          //                         option.textContent = kab;
          //                         kabupatenDropdown.appendChild(option);
          //                     }
          //                 });
          //             } else {
          //                 throw new Error("Data kabupaten tidak valid.");
          //             }
          //         })
          //         .catch(error => {
          //             console.error("Error fetching Kabupaten:", error);
          //             kabupatenDropdown.innerHTML = '<option value="">Gagal memuat data</option>';
          //         });
          // }
      
          // Upload File
          let uploadForm = document.getElementById("uploadForm");
if (uploadForm) {
    uploadForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        let fileInput = document.getElementById("fileInput");
        let tahunInput = document.getElementById("tahun") ? document.getElementById("tahun").value : "";
        let kabupatenInput = document.getElementById("kabupaten") ? document.getElementById("kabupaten").value : "";

        if (!fileInput.files.length || !tahunInput || !kabupatenInput) {
            alert("Silakan lengkapi semua data sebelum upload.");
            return false;
        }

        let loadingIndicator = document.getElementById("loading");
        if (loadingIndicator) loadingIndicator.style.display = "block"; // Tampilkan loader

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("tahun", tahunInput);
        formData.append("kabupaten", kabupatenInput);

        try {
            // Kirim permintaan pertama untuk memeriksa apakah data sudah ada
            let response = await fetch("/api/data/upload-erdkk", {
                method: "POST",
                body: formData
            });

            let data = await response.json();

            if (data.confirmRequired) {
                // Tampilkan dialog konfirmasi
                let confirmUpload = confirm(data.message);
                if (confirmUpload) {
                    // Jika pengguna memilih OK, kirim ulang dengan flag forceUpload
                    formData.append("forceUpload", true);
                    let retryResponse = await fetch("/api/data/upload-erdkk", {
                        method: "POST",
                        body: formData
                    });

                    let retryData = await retryResponse.json();
                    if (retryData.success) {
                        alert(retryData.message); // Tampilkan pesan sukses
                        uploadForm.reset(); // Reset form
                    } else {
                        alert(retryData.message); // Tampilkan pesan error
                    }
                } else {
                    alert("Upload dibatalkan."); // Jika pengguna memilih Batal
                }
            } else if (data.success) {
                alert(data.message); // Tampilkan pesan sukses
                uploadForm.reset(); // Reset form
            } else {
                alert(data.message); // Tampilkan pesan error
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Terjadi kesalahan saat upload.");
        } finally {
            if (loadingIndicator) loadingIndicator.style.display = "none"; // Sembunyikan loader
        }
    });
}
      });
      </script>      
    </body>
</html>