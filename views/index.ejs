<!DOCTYPE html>
<html>
  <head>
    <%- include('./partials/head'); %>
  </head>
  <body>
    <div class="wrapper">
      <%- include('./partials/header'); %>

      <div class="container">
        <div class="page-inner">
          <!-- Header Section -->
          <div
            class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4"
          >
            <div>
              <h3 class="fw-bold mb-3">Monitoring Transaksi Petani</h3>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="card card-stats card-round mb-3">
            <div class="card-body">
              <div class="row align-items-center">
                <div
                  class="col-md-auto d-flex align-items-center gap-3 flex-wrap"
                >
                <div>
                  <label
                    for="tahunSelect"
                    class="text-sm font-medium text-gray-700"
                    >Tahun:</label
                  >
                  <select
                    id="tahunSelect"
                    class="form-select"
                    style="min-width: 150px"
                  >
                    <option value="">Semua Tahun</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                  </select>
                </div>
                  <!-- Kabupaten Select -->
                  <div>
                    <label
                      for="kabupatenSelect"
                      class="text-sm font-medium text-gray-700"
                      >Kabupaten:</label
                    >
                    <select
                      id="kabupatenSelect"
                      class="form-select"
                      style="min-width: 180px"
                    >
                      <option value="">Pilih Kabupaten</option>
              <option value="BOYOLALI">BOYOLALI</option>
              <option value="SRAGEN">SRAGEN</option>
              <option value="KOTA SURAKARTA">KOTA SURAKARTA</option>
              <option value="KOTA MAGELANG">KOTA MAGELANG</option>
              <option value="MAGELANG">MAGELANG</option>
              <option value="SUKOHARJO">SUKOHARJO</option>
              <option value="KLATEN">KLATEN</option>
              <option value="WONOGIRI">WONOGIRI</option>
              <option value="KARANGANYAR">KARANGANYAR</option>
              <option value="BANTUL">BANTUL</option>
              <option value="KOTA YOGYAKARTA">KOTA YOGYAKARTA</option>
              <option value="SLEMAN">SLEMAN</option>
              <option value="KULON PROGO">KULON PROGO</option>
              <option value="GUNUNG KIDUL">GUNUNG KIDUL</option>
                    </select>
                  </div>
                  <!-- Kecamatan Select -->
                  <div>
                    <label
                      for="kecamatanSelect"
                      class="text-sm font-medium text-gray-700"
                      >Kecamatan:</label
                    >
                    <select
                      id="kecamatanSelect"
                      class="form-select"
                      style="min-width: 180px"
                    >
                      <option value="">Pilih Kecamatan</option>
                    </select>
                  </div>
                  <!-- Filter Button -->
                  <div>
                    <button class="btn btn-primary mt-4">
                      <i class="fas fa-filter"></i> Filter
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Cards Section -->
          <div class="row">
            <!-- Urea Card -->
            <div class="col-sm-6 col-md-3">
              <div class="card card-stats card-round">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-icon">
                      <div
                        class="icon-big text-center icon-primary bubble-shadow-small"
                      >
                        <i class="fas fa-box fa-lg"></i>
                      </div>
                    </div>
                    <div class="col col-stats ms-3 ms-sm-0">
                      <div class="numbers">
                        <p class="card-category">Urea</p>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 p-2 bg-light rounded">
                    <div
                      class="p-1 border border-primary-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-clipboard-list text-primary"></i>
                        Alokasi:
                        <span class="fw-bold text-primary" id="sum-urea-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-success-subtle rounded mb-1 bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-check-circle text-success"></i>
                        Realisasi:
                        <span class="fw-bold text-success" id="sum-urea"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-purple-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-friends text-purple"></i> Jumlah
                        Petani:
                        <span
                          class="fw-bold text-purple"
                          id="count-urea-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-danger-subtle rounded bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-check text-danger"></i> Petani
                        Realisasi:
                        <span class="fw-bold text-danger" id="count-urea"
                          >0</span
                        >
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- NPK Card -->
            <div class="col-sm-6 col-md-3">
              <div class="card card-stats card-round">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-icon">
                      <div
                        class="icon-big text-center icon-info bubble-shadow-small"
                      >
                        <i class="fas fa-boxes fa-lg"></i>
                      </div>
                    </div>
                    <div class="col col-stats ms-3 ms-sm-0">
                      <div class="numbers">
                        <p class="card-category">NPK</p>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 p-2 bg-light rounded">
                    <div
                      class="p-1 border border-primary-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-clipboard-list text-primary"></i>
                        Alokasi:
                        <span class="fw-bold text-primary" id="sum-npk-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-success-subtle rounded mb-1 bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-check-circle text-success"></i>
                        Realisasi:
                        <span class="fw-bold text-success" id="sum-npk">0</span>
                      </p>
                    </div>
                    <div
                      class="p-1 border border-purple-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-friends text-purple"></i> Jumlah
                        Petani:
                        <span class="fw-bold text-purple" id="count-npk-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-danger-subtle rounded bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-check text-danger"></i> Petani
                        Realisasi:
                        <span class="fw-bold text-danger" id="count-npk"
                          >0</span
                        >
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- NPK Formula Card -->
            <div class="col-sm-6 col-md-3">
              <div class="card card-stats card-round">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-icon">
                      <div
                        class="icon-big text-center icon-success bubble-shadow-small"
                      >
                        <i class="fas fa-leaf"></i>
                      </div>
                    </div>
                    <div class="col col-stats ms-3 ms-sm-0">
                      <div class="numbers">
                        <p class="card-category">NPK Formula</p>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 p-2 bg-light rounded">
                    <div
                      class="p-1 border border-primary-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-clipboard-list text-primary"></i>
                        Alokasi:
                        <span
                          class="fw-bold text-primary"
                          id="sum-npk-formula-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-success-subtle rounded mb-1 bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-check-circle text-success"></i>
                        Realisasi:
                        <span class="fw-bold text-success" id="sum-npk-formula"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-purple-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-friends text-purple"></i> Jumlah
                        Petani:
                        <span
                          class="fw-bold text-purple"
                          id="count-npk-formula-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-danger-subtle rounded bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-check text-danger"></i> Petani
                        Realisasi:
                        <span class="fw-bold text-danger" id="count-npk-formula"
                          >0</span
                        >
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Organik Card -->
            <div class="col-sm-6 col-md-3">
              <div class="card card-stats card-round">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-icon">
                      <div
                        class="icon-big text-center icon-secondary bubble-shadow-small"
                      >
                        <i class="fas fa-box fa-lg"></i>
                      </div>
                    </div>
                    <div class="col col-stats ms-3 ms-sm-0">
                      <div class="numbers">
                        <p class="card-category">Organik</p>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 p-2 bg-light rounded">
                    <div
                      class="p-1 border border-primary-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-clipboard-list text-primary"></i>
                        Alokasi:
                        <span
                          class="fw-bold text-primary"
                          id="sum-organik-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-success-subtle rounded mb-1 bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-check-circle text-success"></i>
                        Realisasi:
                        <span class="fw-bold text-success" id="sum-organik"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-purple-subtle rounded mb-1 bg-white"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-friends text-purple"></i> Jumlah
                        Petani:
                        <span
                          class="fw-bold text-purple"
                          id="count-organik-alokasi"
                          >0</span
                        >
                      </p>
                    </div>
                    <div
                      class="p-1 border border-danger-subtle rounded bg-light"
                    >
                      <p class="text-muted small mb-0">
                        <i class="fas fa-user-check text-danger"></i> Petani
                        Realisasi:
                        <span class="fw-bold text-danger" id="count-organik"
                          >0</span
                        >
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart Section -->
          <div class="row">
            <div class="col-md-12">
              <div class="card card-round">
                <div class="card-header">
                  <div class="card-head-row">
                    <div class="card-title">Tren Penebusan DIY & Jateng 3</div>
                  </div>
                  <label class="block mb-2 font-semibold"
                    >Pilih Kabupaten:</label
                  >
                  <select
                    id="pilihKabupaten"
                    multiple="multiple"
                    class="w-full border p-2 rounded"
                  ></select>
                </div>
                <div class="card-body">
                  <div class="chart-container" style="min-height: 375px">
                    <canvas
                      id="statisticsChart"
                      width="400"
                      height="200"
                    ></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%- include('./partials/footer'); %>

      <!-- End Custom template -->
    </div>
    <!--   Core JS Files   -->
    <script src="./assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="./assets/js/core/popper.min.js"></script>
    <script src="./assets/js/core/bootstrap.min.js"></script>

    <!-- jQuery Scrollbar -->
    <script src="./assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>

    <!-- Chart JS -->
    <script src="./assets/js/plugin/chart.js/chart.min.js"></script>

    <!-- jQuery Sparkline -->
    <script src="./assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>

    <!-- Chart Circle -->
    <script src="./assets/js/plugin/chart-circle/circles.min.js"></script>

    <!-- Datatables -->
    <script src="./assets/js/plugin/datatables/datatables.min.js"></script>

    <!-- Bootstrap Notify -->
    <script src="./assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

    <!-- jQuery Vector Maps -->
    <script src="./assets/js/plugin/jsvectormap/jsvectormap.min.js"></script>
    <script src="./assets/js/plugin/jsvectormap/world.js"></script>

    <!-- Sweet Alert -->
    <script src="./assets/js/plugin/sweetalert/sweetalert.min.js"></script>

    <!-- Kaiadmin JS -->
    <script src="./assets/js/kaiadmin.min.js"></script>

    <!-- Kaiadmin DEMO methods, don't include it in your project! -->
    <script src="./assets/js/setting-demo.js"></script>
    <script src="./assets/js/demo.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const kabupatenSelect = document.getElementById("kabupatenSelect");
        const kecamatanSelect = document.getElementById("kecamatanSelect");
        const tahunSelect = document.getElementById("tahunSelect");

        if (!kabupatenSelect || !kecamatanSelect || !tahunSelect) {
          console.error("Dropdown filter tidak ditemukan di halaman.");
          return;
        }

        console.log("Semua elemen dropdown ditemukan. Memulai fetch...");

        // 🔹 Fetch SUM berdasarkan filter (Kabupaten, Kecamatan, Tahun)
        function fetchSum() {
          let selectedKabupaten = kabupatenSelect.value;
          let selectedKecamatan = kecamatanSelect.value;
          let selectedTahun = tahunSelect.value;

          let queryParams = new URLSearchParams({
            kabupaten: selectedKabupaten || "",
            kecamatan: selectedKecamatan || "",
            tahun: selectedTahun || "",
          });

          console.log("Fetching SUM dengan filter:", queryParams.toString());

          // Fetch SUM penebusan dari /verval/summary
          fetch(`/api/verval/summary?${queryParams}`)
            .then((res) => res.json())
            .then((vervalData) => {
              console.log("SUM Penebusan:", vervalData);

              // Fetch SUM alokasi dari /erdkk/summary
              fetch(`/api/erdkk/summary?${queryParams}`)
                .then((res) => res.json())
                .then((erdkkData) => {
                  console.log("SUM Alokasi:", erdkkData);

                  // Fungsi untuk menghitung persentase
                  const calculatePercentage = (tebus, alokasi) => {
                    if (alokasi === 0) return "0%"; // Hindari pembagian nol
                    return ((tebus / alokasi) * 100).toFixed(2) + "%";
                  };

                  // Urea
                  const totalUrea = vervalData.total_urea || 0;
                  const totalUreaAlokasi = erdkkData.total_urea || 0;
                  document.getElementById("sum-urea").textContent =
                    //  `${calculatePercentage(totalUrea, totalUreaAlokasi)}`;
                    `${totalUrea.toLocaleString("id-ID")} (${calculatePercentage(totalUrea, totalUreaAlokasi)})`;

                  // NPK
                  const totalNpk = vervalData.total_npk || 0;
                  const totalNpkAlokasi = erdkkData.total_npk || 0;
                  document.getElementById("sum-npk").textContent =
                    //  `${calculatePercentage(totalNpk, totalNpkAlokasi)}`;
                    `${totalNpk.toLocaleString("id-ID")} (${calculatePercentage(totalNpk, totalNpkAlokasi)})`;

                  // NPK Formula
                  const totalNpkFormula = vervalData.total_npk_formula || 0;
                  const totalNpkFormulaAlokasi =
                    erdkkData.total_npk_formula || 0;
                  document.getElementById("sum-npk-formula").textContent =
                    //  `${calculatePercentage(totalNpkFormula, totalNpkFormulaAlokasi)}`;
                    `${totalNpkFormula.toLocaleString("id-ID")} (${calculatePercentage(totalNpkFormula, totalNpkFormulaAlokasi)})`;

                  // Organik
                  const totalOrganik = vervalData.total_organik || 0;
                  const totalOrganikAlokasi = erdkkData.total_organik || 0;
                  document.getElementById("sum-organik").textContent =
                    //  `${calculatePercentage(totalOrganik, totalOrganikAlokasi)}`;
                    `${totalOrganik.toLocaleString("id-ID")} (${calculatePercentage(totalOrganik, totalOrganikAlokasi)})`;
                })
                .catch((error) =>
                  console.error("Error fetching sum alokasi:", error)
                );
            })
            .catch((error) =>
              console.error("Error fetching sum penebusan:", error)
            );

          fetch(`/api/verval/count?${queryParams}`)
            .then((res) => res.json())
            .then((vervalData) => {
              console.log("Count Penebusan:", vervalData);

              // Fetch SUM alokasi dari /erdkk/summary
              fetch(`/api/erdkk/count?${queryParams}`)
                .then((res) => res.json())
                .then((erdkkData) => {
                  console.log("Count Alokasi:", erdkkData);

                  // Fungsi untuk menghitung persentase
                  const calculatePercentage = (tebus, alokasi) => {
                    if (alokasi === 0) return "0%"; // Hindari pembagian nol
                    return ((tebus / alokasi) * 100).toFixed(2) + "%";
                  };

                  // Urea
                  const countUrea = vervalData.count_urea || 0;
                  const countUreaAlokasi = erdkkData.count_urea || 0;
                  document.getElementById("count-urea").textContent =
                    //  `${calculatePercentage(totalUrea, totalUreaAlokasi)}`;
                    `${countUrea.toLocaleString("id-ID")} (${calculatePercentage(countUrea, countUreaAlokasi)})`;

                  // NPK
                  const countNpk = vervalData.count_npk || 0;
                  const countNpkAlokasi = erdkkData.count_npk || 0;
                  document.getElementById("count-npk").textContent =
                    //  `${calculatePercentage(totalNpk, totalNpkAlokasi)}`;
                    `${countNpk.toLocaleString("id-ID")} (${calculatePercentage(countNpk, countNpkAlokasi)})`;

                  // NPK Formula
                  const countNpkFormula = vervalData.count_npk_formula || 0;
                  const countNpkFormulaAlokasi =
                    erdkkData.count_npk_formula || 0;
                  document.getElementById("count-npk-formula").textContent =
                    //  `${calculatePercentage(totalNpkFormula, totalNpkFormulaAlokasi)}`;
                    `${countNpkFormula.toLocaleString("id-ID")} (${calculatePercentage(countNpkFormula, countNpkFormulaAlokasi)})`;

                  // Organik
                  const countOrganik = vervalData.count_organik || 0;
                  const countOrganikAlokasi = erdkkData.count_organik || 0;
                  document.getElementById("count-organik").textContent =
                    //  `${calculatePercentage(totalOrganik, totalOrganikAlokasi)}`;
                    `${countOrganik.toLocaleString("id-ID")} (${calculatePercentage(countOrganik, countOrganikAlokasi)})`;
                })
                .catch((error) =>
                  console.error("Error fetching count alokasi:", error)
                );
            })
            .catch((error) =>
              console.error("Error fetching count penebusan:", error)
            );

          // Fetch SUM alokasi dari /erdkk/summary
          fetch(`/api/erdkk/summary?${queryParams}`)
            .then((res) => res.json())
            .then((data) => {
              console.log("SUM Alokasi:", data);

              document.getElementById("sum-urea-alokasi").textContent =
                parseFloat(data.total_urea || 0).toLocaleString("id-ID");

              document.getElementById("sum-npk-alokasi").textContent =
                parseFloat(data.total_npk || 0).toLocaleString("id-ID");

              document.getElementById("sum-npk-formula-alokasi").textContent =
                parseFloat(data.total_npk_formula || 0).toLocaleString("id-ID");

              document.getElementById("sum-organik-alokasi").textContent =
                parseFloat(data.total_organik || 0).toLocaleString("id-ID");
            })
            .catch((error) =>
              console.error("Error fetching sum alokasi:", error)
            );

          fetch(`/api/erdkk/count?${queryParams}`)
            .then((res) => res.json())
            .then((data) => {
              console.log("Count Alokasi:", data);

              document.getElementById("count-urea-alokasi").textContent = (
                data.count_urea || 0
              ).toLocaleString("id-ID");

              document.getElementById("count-npk-alokasi").textContent = (
                data.count_npk || 0
              ).toLocaleString("id-ID");

              document.getElementById("count-npk-formula-alokasi").textContent =
                (data.count_npk_formula || 0).toLocaleString("id-ID");

              document.getElementById("count-organik-alokasi").textContent = (
                data.count_organik || 0
              ).toLocaleString("id-ID");
            })
            .catch((error) =>
              console.error("Error fetching count alokasi:", error)
            );
        }

        // 🔹 Update Dropdown Kabupaten & Kecamatan
        function updateDropdowns() {
          fetch("/api/filters")
            .then((res) => res.json())
            .then((data) => {
              console.log("Data Filters:", data);

              // Populate Kecamatan Dropdown
              kecamatanSelect.innerHTML =
                '<option value="">Semua Kecamatan</option>';
              data.kecamatan.forEach((kec) => {
                kecamatanSelect.innerHTML += `<option value="${kec}">${kec}</option>`;
              });
            })
            .catch((error) => console.error("Error fetching filters:", error));
        }

        // 🔹 Event Listener untuk Filter
        kabupatenSelect.addEventListener("change", fetchSum);
        kecamatanSelect.addEventListener("change", fetchSum);
        tahunSelect.addEventListener("change", fetchSum);

        // 🔹 Jalankan fetch saat halaman dimuat
        updateDropdowns();
      });

      $("#lineChart").sparkline([102, 109, 120, 99, 110, 105, 115], {
        type: "line",
        height: "70",
        width: "100%",
        lineWidth: "2",
        lineColor: "#177dff",
        fillColor: "rgba(23, 125, 255, 0.14)",
      });

      $("#lineChart2").sparkline([99, 125, 122, 105, 110, 124, 115], {
        type: "line",
        height: "70",
        width: "100%",
        lineWidth: "2",
        lineColor: "#f3545d",
        fillColor: "rgba(243, 84, 93, .14)",
      });

      $("#lineChart3").sparkline([105, 103, 123, 100, 95, 105, 115], {
        type: "line",
        height: "70",
        width: "100%",
        lineWidth: "2",
        lineColor: "#ffa534",
        fillColor: "rgba(255, 165, 52, .14)",
      });

      ("use strict");

      $(document).ready(function () {
        let rawData = [];

        var diyList = [
          "BANTUL",
          "KOTA YOGYAKARTA",
          "SLEMAN",
          "KULON PROGO",
          "GUNUNG KIDUL",
        ];
        var jatengList = [
          "KOTA MAGELANG",
          "MAGELANG",
          "SRAGEN",
          "BOYOLALI",
          "KLATEN",
          "SUKOHARJO",
          "KARANGANYAR",
          "KOTA SURAKARTA",
          "WONOGIRI",
        ];

        var colors = [
          "#f3545d",
          "#1d8cf8",
          "#902C9C",
          "#50e3c2",
          "#4a90e2",
          "#f8e71c",
          "#7ed321",
          "#b8e986",
          "#ff7f50",
        ];

        function processData(selectedKabupaten) {
          let datasets = [];

          if (selectedKabupaten.length === 0) {
            selectedKabupaten = ["DIY", "Jateng 3"];
          }

          selectedKabupaten.forEach((kab, index) => {
            let dataPerBulan = Array(12).fill(0);

            rawData.forEach((entry) => {
              let monthIndex = [
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec",
              ].indexOf(entry.bulan);

              if (
                (kab === "DIY" && diyList.includes(entry.kabupaten)) ||
                (kab === "Jateng 3" && jatengList.includes(entry.kabupaten)) ||
                entry.kabupaten === kab
              ) {
                dataPerBulan[monthIndex] += entry.total;
              }
            });

            datasets.push({
              label: kab,
              borderColor: colors[index % colors.length],
              pointBackgroundColor: colors[index % colors.length],
              pointRadius: 4,
              backgroundColor: colors[index % colors.length] + "40",
              fill: true,
              borderWidth: 2,
              data: dataPerBulan,
            });
          });

          return datasets;
        }

        var ctx = document.getElementById("statisticsChart").getContext("2d");

        var statisticsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ],
            datasets: [],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: true },
          },
        });

        fetch("http://localhost:3000/api/data/summary")
          .then((response) => response.json())
          .then((responseData) => {
            console.log("Data dari API:", responseData);

            let data = responseData.data;
            if (!Array.isArray(data)) {
              console.error("Data bukan array!", data);
              return;
            }

            rawData = data.map((row) => ({
              bulan: row.bulan,
              kabupaten: row.kabupaten,
              total: row.total,
            }));

            statisticsChart.data.datasets = processData([]);
            statisticsChart.update();

            // **Tambahkan Select2 ke dalam dropdown**
            let allKabupaten = [
              ...new Set(rawData.map((row) => row.kabupaten)),
            ].sort();

            if (allKabupaten.length === 0) {
              console.error("Daftar kabupaten kosong!");
              return;
            }

            $("#pilihKabupaten").empty(); // Hapus opsi lama
            allKabupaten.forEach((kab) => {
              $("#pilihKabupaten").append(new Option(kab, kab));
            });

            $("#pilihKabupaten").select2({
              placeholder: "Pilih kabupaten...",
              allowClear: true,
              closeOnSelect: false,
              multiple: true,
              width: "100%",
              dropdownAutoWidth: true,
              minimumResultsForSearch: Infinity, // Hanya muncul saat diklik
              templateResult: function (data) {
                if (!data.id) {
                  return data.text;
                }
                return $(
                  '<span><input type="checkbox" class="select2-checkbox"/> ' +
                    data.text +
                    "</span>"
                );
              },
              templateSelection: function (data) {
                return data.text;
              },
            });
          })
          .catch((error) => console.error("Error fetching data:", error));

        // **Event listener untuk Select2**
        $("#pilihKabupaten").on("change", function () {
          let selected = $(this).val() || [];
          statisticsChart.data.datasets = processData(selected);
          statisticsChart.update();
        });

        // **Agar dropdown tidak auto-muncul**
        $("#pilihKabupaten").on("select2:opening", function (e) {
          if ($(this).hasClass("open")) {
            e.preventDefault();
            $(this).removeClass("open");
          } else {
            $(this).addClass("open");
          }
        });
      });
    </script>
  </body>
</html>
